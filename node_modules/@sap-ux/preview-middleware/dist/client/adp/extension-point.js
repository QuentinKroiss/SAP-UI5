'use strict';
sap.ui.define([
    'sap/ui/rta/plugin/AddXMLAtExtensionPoint',
    'sap/ui/rta/command/CommandFactory',
    'open/ux/preview/client/thirdparty/@sap-ux-private/control-property-editor-common',
    './utils',
    './init-dialogs'
], function (AddXMLAtExtensionPoint, CommandFactory, ___sap_ux_private_control_property_editor_common, ___utils, ___init_dialogs) {
    'use strict';
    const addExtensionPoint = ___sap_ux_private_control_property_editor_common['addExtensionPoint'];
    const createDeferred = ___utils['createDeferred'];
    const DialogNames = ___init_dialogs['DialogNames'];
    const handler = ___init_dialogs['handler'];
    class ExtensionPointService {
        actionId = 'CTX_ADDXML_AT_EXTENSIONPOINT';
        constructor(rta) {
            this.rta = rta;
        }
        init(subscribe) {
            this.initPlugin();
            subscribe(async action => {
                if (addExtensionPoint.match(action)) {
                    try {
                        const {controlId, name} = action.payload;
                        const service = await this.rta.getService('action');
                        service.execute(controlId, this.actionId);
                        this.selectedExtensionPointName = name;
                    } catch (e) {
                        throw new Error(`Failed to execute service with actionId: ${ this.actionId }`);
                    }
                }
            });
        }
        initPlugin() {
            const flexSettings = this.rta.getFlexSettings();
            const commandFactory = new CommandFactory({ flexSettings });
            const plugin = new AddXMLAtExtensionPoint({
                commandFactory,
                fragmentHandler: async (overlay, info) => await this.fragmentHandler(overlay, info)
            });
            const defaultPlugins = this.rta.getDefaultPlugins();
            defaultPlugins.addXMLAtExtensionPoint = plugin;
            this.rta.setPlugins(defaultPlugins);
        }
        async fragmentHandler(overlay, info) {
            let deferred = createDeferred();
            const name = this.selectedExtensionPointName;
            await handler(overlay, this.rta, DialogNames.ADD_FRAGMENT_AT_EXTENSION_POINT, {
                name,
                info,
                deferred
            });
            this.selectedExtensionPointName = '';
            return deferred.promise;
        }
    }
    return ExtensionPointService;
});