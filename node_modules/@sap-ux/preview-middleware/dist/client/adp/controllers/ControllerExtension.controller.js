"use strict";

sap.ui.define(["sap/m/MessageToast", "sap/ui/core/library", "sap/ui/model/json/JSONModel", "sap/ui/fl/Utils", "../api-handler", "./BaseDialog.controller"], function (MessageToast, sap_ui_core_library, JSONModel, Utils, ___api_handler, __BaseDialog) {
  "use strict";

  function _interopRequireDefault(obj) {
    return obj && obj.__esModule && typeof obj.default !== "undefined" ? obj.default : obj;
  }
  /** sap.ui.core */
  const ValueState = sap_ui_core_library["ValueState"];
  /** sap.ui.base */
  const getExistingController = ___api_handler["getExistingController"];
  const getManifestAppdescr = ___api_handler["getManifestAppdescr"];
  const readControllers = ___api_handler["readControllers"];
  const writeChange = ___api_handler["writeChange"];
  const writeController = ___api_handler["writeController"];
  const BaseDialog = _interopRequireDefault(__BaseDialog);
  /**
   * @namespace open.ux.preview.client.adp.controllers
   */
  const ControllerExtension = BaseDialog.extend("open.ux.preview.client.adp.controllers.ControllerExtension", {
    constructor: function _constructor(name, overlays, rta) {
      BaseDialog.prototype.constructor.call(this, name);
      this.rta = rta;
      this.overlays = overlays;
      this.model = new JSONModel();
    },
    setup: async function _setup(dialog) {
      this.dialog = dialog;
      this.setEscapeHandler();
      await this.buildDialogData();
      this.dialog.setModel(this.model);
      this.dialog.open();
    },
    onControllerNameInputChange: function _onControllerNameInputChange(event) {
      const input = event.getSource();
      const beginBtn = this.dialog.getBeginButton();
      const controllerName = input.getValue();
      const controllerList = this.model.getProperty('/controllersList');
      const updateDialogState = function (valueState) {
        let valueStateText = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';
        input.setValueState(valueState).setValueStateText(valueStateText);
        beginBtn.setEnabled(valueState === ValueState.Success);
      };
      if (controllerName.length <= 0) {
        updateDialogState(ValueState.None);
        this.model.setProperty('/newControllerName', null);
        return;
      }
      const fileExists = controllerList.some(f => f.controllerName === `${controllerName}.js`);
      if (fileExists) {
        updateDialogState(ValueState.Error, 'Enter a different name. The controller name that you entered already exists in your project.');
        return;
      }
      const isValidName = /^[a-zA-Z_][a-zA-Z0-9_-]*$/.test(controllerName);
      if (!isValidName) {
        updateDialogState(ValueState.Error, 'The controller name cannot contain white spaces or special characters.');
        return;
      }
      if (controllerName.length > 64) {
        updateDialogState(ValueState.Error, 'A controller file name cannot contain more than 64 characters.');
        return;
      }
      updateDialogState(ValueState.Success);
      this.model.setProperty('/newControllerName', controllerName);
    },
    onCreateBtnPress: async function _onCreateBtnPress(event) {
      const source = event.getSource();
      const controllerExists = this.model.getProperty('/controllerExists');
      if (!controllerExists) {
        source.setEnabled(false);
        const controllerName = this.model.getProperty('/newControllerName');
        const viewId = this.model.getProperty('/viewId');
        await this.createNewController(controllerName, viewId);
      } else {
        const controllerPath = this.model.getProperty('/controllerPath');
        window.open(`vscode://file${controllerPath}`);
      }
      this.handleDialogClose();
    },
    buildDialogData: async function _buildDialogData() {
      const selectorId = this.overlays.getId();
      const overlayControl = sap.ui.getCore().byId(selectorId);
      const {
        controllerName,
        viewId
      } = this.getControllerInfo(overlayControl);
      const {
        controllerExists,
        controllerPath,
        controllerPathFromRoot
      } = await this.getExistingController(controllerName);
      if (controllerExists) {
        this.updateModelForExistingController(controllerExists, controllerPath, controllerPathFromRoot);
      } else {
        this.updateModelForNewController(viewId);
        await this.getControllers();
      }
    },
    getControllerInfo: function _getControllerInfo(overlayControl) {
      const control = overlayControl.getElement();
      const view = Utils.getViewForControl(control);
      const controllerName = view.getController().getMetadata().getName();
      const viewId = view.getId();
      return {
        controllerName,
        viewId
      };
    },
    updateModelForExistingController: function _updateModelForExistingController(controllerExists, controllerPath, controllerPathFromRoot) {
      this.model.setProperty('/controllerExists', controllerExists);
      this.model.setProperty('/controllerPath', controllerPath);
      this.model.setProperty('/controllerPathFromRoot', controllerPathFromRoot);
      const content = this.dialog.getContent();
      const form = content[0];
      form.setVisible(false);
      const messageForm = content[1];
      messageForm.setVisible(true);
      this.dialog.getBeginButton().setText('Open in VS Code').setEnabled(true);
      this.dialog.getEndButton().setText('Close');
    },
    updateModelForNewController: function _updateModelForNewController(viewId) {
      this.model.setProperty('/viewId', viewId);
    },
    getExistingController: async function _getExistingController(controllerName) {
      try {
        const data = await getExistingController(controllerName);
        return data;
      } catch (e) {
        MessageToast.show(e.message, {
          duration: 5000
        });
        throw new Error(e.message);
      }
    },
    getControllers: async function _getControllers() {
      try {
        const {
          controllers
        } = await readControllers();
        this.model.setProperty('/controllersList', controllers);
      } catch (e) {
        MessageToast.show(e.message, {
          duration: 5000
        });
        throw new Error(e.message);
      }
    },
    createNewController: async function _createNewController(controllerName, viewId) {
      try {
        const manifest = await getManifestAppdescr();
        await writeController({
          controllerName,
          projectId: manifest.id
        });
        const controllerRef = {
          codeRef: `coding/${controllerName}.js`,
          viewId
        };
        const service = await this.rta.getService('controllerExtension');
        const change = await service.add(controllerRef.codeRef, controllerRef.viewId);
        change.creation = new Date().toISOString();
        await writeChange(change);
        MessageToast.show(`Controller extension with name '${controllerName}' was created.`);
      } catch (e) {
        // We want to update the model incase we have already created a controller file but failed when creating a change file,
        // so when the user types the same controller name again he does not get 409 from the server, instead an error is shown in the UI
        await this.getControllers();
        MessageToast.show(e.message);
        throw new Error(e.message);
      }
    }
  });
  return ControllerExtension;
});
//# sourceMappingURL=ControllerExtension.controller.js.map