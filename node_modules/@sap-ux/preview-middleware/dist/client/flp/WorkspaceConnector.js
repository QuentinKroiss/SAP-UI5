"use strict";

sap.ui.define(["sap/base/util/merge", "sap/ui/fl/write/api/connectors/ObjectStorageConnector", "sap/ui/fl/Layer", "sap/ui/VersionInfo", "./common"], function (merge, ObjectStorageConnector, Layer, VersionInfo, ___common) {
  "use strict";

  const CHANGES_API_PATH = ___common["CHANGES_API_PATH"];
  const getFlexSettings = ___common["getFlexSettings"];
  const connector = merge({}, ObjectStorageConnector, {
    layers: [Layer.VENDOR, Layer.CUSTOMER_BASE],
    storage: {
      _itemsStoredAsObjects: true,
      fileChangeRequestNotifier: undefined,
      setItem: function (_key, change) {
        const settings = getFlexSettings();
        if (settings) {
          change.support ??= {};
          change.support.generator = settings.generator;
        }
        if (typeof this.fileChangeRequestNotifier === 'function' && change.fileName) {
          try {
            this.fileChangeRequestNotifier(change.fileName, 'create', change.changeType);
          } catch (e) {
            // exceptions in the listener call are ignored
          }
        }
        return fetch(CHANGES_API_PATH, {
          method: 'POST',
          body: JSON.stringify(change, null, 2),
          headers: {
            'content-type': 'application/json'
          }
        });
      },
      removeItem: function (key) {
        if (typeof this.fileChangeRequestNotifier === 'function') {
          try {
            this.fileChangeRequestNotifier(key, 'delete');
          } catch (e) {
            // exceptions in the listener call are ignored
          }
        }
        return fetch(CHANGES_API_PATH, {
          method: 'DELETE',
          body: JSON.stringify({
            fileName: key
          }),
          headers: {
            'content-type': 'application/json'
          }
        });
      },
      clear: function () {
        // not implemented
      },
      getItem: function (_key) {
        // not implemented
      },
      getItems: async function () {
        const response = await fetch(CHANGES_API_PATH, {
          method: 'GET',
          headers: {
            'content-type': 'application/json'
          }
        });
        const changes = await response.json();
        return changes;
      }
    },
    loadFeatures: async function () {
      const features = await ObjectStorageConnector.loadFeatures();
      const ui5Version = await VersionInfo.load();
      const [majorVersion, minorVersion] = ui5Version.version.split('.').map(v => parseInt(v, 10));
      features.isVariantAdaptationEnabled = majorVersion >= 1 && minorVersion >= 90;
      const settings = getFlexSettings();
      if (settings?.developerMode) {
        features.isVariantAdaptationEnabled = false;
      }
      if (settings?.scenario === 'ADAPTATION_PROJECT') {
        features.isVariantAdaptationEnabled = true;
      }
      return features;
    }
  });
  return connector;
});
//# sourceMappingURL=WorkspaceConnector.js.map